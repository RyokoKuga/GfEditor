<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>GfEditer - 3D Molecular Studio</title>

	<!-- ライブラリ群 -->
	<script src="../../libs/Three.js"></script>
	<script src="../../libs/raphael-min.2.0.1.js"></script>
	<script src="../../libs/kekule/kekule.js?modules=calculation,chemWidget,openbabel"></script>
	<link rel="stylesheet" type="text/css" href="../../libs/kekule/themes/default/kekule.css" />
	
	<style>
		:root {
			--app-bg: #f8f9fa;
			--app-header: #ffffff;
			--app-border: #e0e2e6;
			--app-text-main: #202124;
			--accent-blue: #1a73e8;
			--accent-blue-hover: #1765cc;
			--accent-red: #d93025;
			--accent-green: #1e8e3e;
			--white: #ffffff;
		}

		body {
			background-color: var(--app-bg);
			color: var(--app-text-main);
			font-family: 'Inter', -apple-system, sans-serif;
			margin: 0;
			display: flex;
			flex-direction: column;
			height: 100vh;
			overflow: hidden;
		}

		header {
			background: var(--app-header);
			padding: 0 24px;
			border-bottom: 1px solid var(--app-border);
			display: flex;
			justify-content: space-between;
			align-items: center;
			height: 65px;
			box-shadow: 0 1px 2px rgba(0,0,0,0.05);
			z-index: 100;
		}

		.header-left { display: flex; align-items: center; gap: 20px; }
		.header-right { display: flex; align-items: center; gap: 8px; }
		
		/* ロゴタイトルのスタイル（Gにアクセント） */
		.logo { font-size: 20px; font-weight: 700; color: var(--app-text-main); letter-spacing: -0.5px; }
		.logo span.g-accent { color: var(--accent-blue); }

		#state {
			font-size: 12px;
			color: #174ea6;
			background: #e8f0fe;
			padding: 5px 15px;
			border-radius: 20px;
			font-weight: 500;
		}

		.header-btn {
			padding: 8px 16px;
			border-radius: 6px;
			font-size: 12px;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.2s ease;
			border: 1px solid transparent;
			display: inline-flex;
			align-items: center;
			gap: 6px;
		}

		#ext-btn-gen { background: var(--accent-blue); color: var(--white); }
		#ext-btn-gen:hover { background: var(--accent-blue-hover); }

		#ext-btn-babel { background: var(--white); border-color: var(--app-border); color: var(--app-text-main); }
		#ext-btn-babel:hover { background: #f1f3f4; }
		#ext-btn-babel.active { background: #e6f4ea; color: var(--accent-green); border-color: var(--accent-green); }

		#ext-btn-terminate { background: var(--accent-red); color: var(--white); }
		#ext-btn-terminate:disabled { opacity: 0.3; cursor: default; }

		.app-container {
			flex: 1;
			display: flex;
			padding: 10px;
			min-height: 0;
		}

		.tool-section {
			display: flex;
			flex-direction: column;
			background: #fff;
			border: 1px solid var(--app-border);
			border-radius: 10px;
			overflow: hidden;
		}

		#section-left { flex: 0 0 50%; }
		#section-right { flex: 1; }

		#resizer {
			width: 12px;
			cursor: col-resize;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		#resizer::after { content: ""; width: 2px; height: 30px; background: #ddd; border-radius: 2px; }

		#composer, #chemViewer { width: 100% !important; height: 100% !important; }

		footer {
			background: var(--app-header);
			padding: 0 24px;
			font-size: 11px;
			color: #70757a;
			border-top: 1px solid var(--app-border);
			height: 30px;
			display: flex;
			align-items: center;
			/* 右寄せに設定 */
			justify-content: flex-end; 
		}
	</style>
	
	<script>
	var composer, viewer, domBtnGen, domBtnTerminate, domBtnBabel;	
	var calculator, timeStart;
	
	function report(msg) { document.getElementById('state').innerHTML = msg; }
	
	function enableOpenBabel() {
		Kekule.IO.enableOpenBabelFormats();
		domBtnBabel.classList.add('active');
		domBtnBabel.innerHTML = '✓ OpenBabel Enabled';
		report('OpenBabel Formats Enabled');
	}

	function generate3D() {
		var mol = Kekule.ChemStructureUtils.getTotalStructFragment(composer.getChemObj());
		if (!mol || mol.getNodeCount() === 0) return report('Canvas is empty');

		report('Calculating 3D...');
		domBtnGen.disabled = true;
		domBtnTerminate.disabled = false;
		timeStart = Date.now();

		calculator = Kekule.Calculator.generate3D(mol, {'forceField': 'MMFF94'},
			function(generatedMol){
				domBtnGen.disabled = false;
				domBtnTerminate.disabled = true;
				viewer.setChemObj(generatedMol);
				report('Ready (' + ((Date.now() - timeStart)/1000).toFixed(2) + 's)');
			},
			function(err) {
				domBtnGen.disabled = false;
				domBtnTerminate.disabled = true;
				report('Ready');
			}
		);
	}

	function terminate() {
		if (calculator) calculator.halt();
		report('Terminated');
		domBtnGen.disabled = false;
		domBtnTerminate.disabled = true;
	}

	function syncSizes() {
		if (composer) composer.notifyObjectSizeChanged();
		if (viewer) viewer.notifyObjectSizeChanged();
	}
	
	function init() {
		viewer = Kekule.Widget.getWidgetById('chemViewer');
		composer = Kekule.Widget.getWidgetById('composer');
		domBtnGen = document.getElementById('ext-btn-gen');
		domBtnTerminate = document.getElementById('ext-btn-terminate');
		domBtnBabel = document.getElementById('ext-btn-babel');
		
		const resizer = document.getElementById('resizer');
		const leftSide = document.getElementById('section-left');
		let isResizing = false;

		resizer.addEventListener('mousedown', (e) => { isResizing = true; document.body.style.cursor = 'col-resize'; e.preventDefault(); });
		window.addEventListener('mousemove', (e) => {
			if (!isResizing) return;
			const newWidth = (e.clientX / window.innerWidth) * 100;
			if (newWidth > 15 && newWidth < 85) {
				leftSide.style.flex = `0 0 ${newWidth}%`;
				syncSizes();
			}
		});
		window.addEventListener('mouseup', () => { isResizing = false; document.body.style.cursor = 'default'; });

		window.addEventListener('resize', syncSizes);
		setTimeout(syncSizes, 400);
	}
	
	Kekule.X.domReady(init);
	</script>
</head>

<body>
	<header>
		<div class="header-left">
			<div class="logo"><span class="g-accent">G</span>fEditer</div>
			<div id="state">Ready</div>
		</div>
		<div class="header-right">
			<button id="ext-btn-babel" class="header-btn" onclick="enableOpenBabel()">Enable OpenBabel</button>
			<button id="ext-btn-gen" class="header-btn" onclick="generate3D()">Generate 3D</button>
			<button id="ext-btn-terminate" class="header-btn" onclick="terminate()" disabled>Terminate</button>
		</div>
	</header>

	<div class="app-container">
		<div id="section-left" class="tool-section">
			<div id="composer" data-widget="Kekule.Editor.Composer" data-predefined-setting="molOnly"></div>
		</div>
		
		<div id="resizer"></div>
		
		<div id="section-right" class="tool-section">
			<div id="chemViewer" data-widget="Kekule.ChemWidget.Viewer3D" data-predefined-setting="fullFunc" 
				data-toolbar-evoke-modes="" data-toolbar-pos="1"></div>
		</div>
	</div>

	<footer>
		<div>Powered by Kekule.js</div>
	</footer>
</body>
</html>
