<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>GfEditer - Dual Mode Molecular Studio (Version 026)</title>

	<script src="../../libs/Three.js"></script>
	<script src="../../libs/raphael-min.2.0.1.js"></script>
	<script src="../../libs/kekule/kekule.js?modules=calculation,chemWidget,openbabel"></script>
	<link rel="stylesheet" type="text/css" href="../../libs/kekule/themes/default/kekule.css" />
	
	<style>
		:root {
			--app-bg: #f8f9fa;
			--app-header: #ffffff;
			--app-border: #e0e2e6;
			--accent-blue: #1a73e8;
			--accent-blue-hover: #1765cc;
			--accent-red: #d93025;
			--accent-red-hover: #b31412;
			--accent-orange: #f29900;
			--white: #ffffff;
		}

		body {
			background-color: var(--app-bg);
			font-family: 'Inter', sans-serif;
			margin: 0;
			display: flex;
			flex-direction: column;
			height: 100vh;
			overflow: hidden;
		}

		header {
			background: var(--app-header);
			padding: 0 24px;
			border-bottom: 1px solid var(--app-border);
			display: flex;
			justify-content: space-between;
			align-items: center;
			height: 60px;
			flex-shrink: 0;
		}

		.logo { font-size: 20px; font-weight: 700; }
		#state { font-size: 12px; color: #174ea6; background: #e8f0fe; padding: 5px 15px; border-radius: 20px; margin-left: 15px; }

		.header-right { display: flex; align-items: center; gap: 8px; }

		.header-btn {
			padding: 8px 16px; border-radius: 6px; font-size: 12px; font-weight: 600;
			cursor: pointer; transition: all 0.25s;
			border: 1px solid transparent;
			display: inline-flex; align-items: center; gap: 5px;
			white-space: nowrap;
		}

		#ext-btn-gen { background: var(--accent-blue); color: var(--white); }
		#ext-btn-gen:hover:not(:disabled) { background: var(--accent-blue-hover); transform: translateY(-1px); }

		#ext-btn-terminate { background-color: var(--accent-red); color: var(--white); border-color: var(--accent-red); }
		#ext-btn-terminate:disabled { background-color: transparent; color: #bdc1c6; border-color: #e0e2e6; opacity: 0.35; cursor: default; }

		#ext-btn-babel { background: white; border-color: var(--app-border); color: #3c4043; }
		#ext-btn-babel.active { background: #e6f4ea; color: #1e8e3e; border-color: #1e8e3e; }

		#ext-btn-switch { background: #3c4043; color: var(--white); margin-left: 4px; }

		.app-container { flex: 1; position: relative; min-height: 0; }

		.mode-panel {
			position: absolute; top: 0; left: 0; width: 100%; height: 100%;
			display: none; padding: 10px; box-sizing: border-box; gap: 10px;
		}
		.mode-panel.active { display: flex; }

		.tool-pane { display: flex; flex-direction: column; background: #fff; border: 1px solid var(--app-border); border-radius: 10px; overflow: hidden; }
		.col-left { flex: 0 0 50%; }
		.col-right { flex: 1; position: relative; }
		.resizer { width: 10px; cursor: col-resize; display: flex; align-items: center; justify-content: center; z-index: 10; }
		.resizer::after { content: ""; width: 2px; height: 40px; background: #ddd; border-radius: 2px; }

		#composer, #chemViewer { width: 100% !important; height: 100% !important; }

		#gamess-config { padding: 30px 40px; background: #fdfdfd; overflow-y: auto; }
		.config-grid { display: grid; grid-template-columns: 1fr; gap: 15px; max-width: 400px; }
		.config-group label { font-size: 11px; font-weight: 700; color: #5f6368; text-transform: uppercase; letter-spacing: 0.5px; }
		.config-group select { padding: 9px; border-radius: 6px; border: 1px solid var(--app-border); font-size: 13px; width: 100%; background-color: white; }

		#gamess-editor {
			flex: 1; border: none; padding: 20px;
			font-family: 'Consolas', 'Monaco', monospace; font-size: 14px; line-height: 1.6;
			background: #1e1e1e; color: #d4d4d4; outline: none; resize: none;
			-webkit-user-select: text; user-select: text;
		}
		.editor-footer { padding: 10px 20px; background: #2d2d2d; display: flex; justify-content: flex-end; }
		#ext-btn-download { background: var(--accent-orange); color: white; border: none; padding: 8px 20px; border-radius: 4px; font-weight: 600; cursor: pointer; }

		footer { background: var(--app-header); padding: 0 24px; font-size: 11px; color: #70757a; border-top: 1px solid var(--app-border); height: 25px; display: flex; align-items: center; justify-content: flex-end; }
	</style>
</head>

<body>
	<header>
		<div style="display:flex; align-items:center;">
			<div class="logo"><span style="color:var(--accent-blue)">G</span>fEditer</div>
			<div id="state">Modeling Mode</div>
		</div>
		<div class="header-right">
			<button id="ext-btn-gen" class="header-btn" onclick="generate3D()">Generate 3D</button>
			<button id="ext-btn-terminate" class="header-btn" onclick="terminate()" disabled>Terminate</button>
			<button id="ext-btn-babel" class="header-btn" onclick="enableOpenBabel()">Enable OpenBabel</button>
			<button id="ext-btn-switch" class="header-btn" onclick="toggleMode()">Switch to Editor Mode</button>
		</div>
	</header>

	<div class="app-container">
		<div id="panel-modeling" class="mode-panel active">
			<div id="pane-2d" class="tool-pane col-left">
				<div id="composer" data-widget="Kekule.Editor.Composer" data-predefined-setting="molOnly"></div>
			</div>
			<div class="resizer" id="resizer-modeling"></div>
			<div id="pane-3d" class="tool-pane col-right">
				<div id="chemViewer" data-widget="Kekule.ChemWidget.Viewer3D" data-predefined-setting="fullFunc"></div>
			</div>
		</div>

		<div id="panel-gamess" class="mode-panel">
			<div id="gamess-config" class="tool-pane col-left">
				<h2 style="margin-top:0; font-size:18px; color:var(--accent-blue);">GAMESS Configuration</h2>
				<div class="config-grid">
					<div class="config-group">
						<label>Run Type</label>
						<select id="cfg-run" onchange="updateGamessText()">
							<option value="OPTIMIZE">OPTIMIZE</option>
							<option value="ENERGY">ENERGY</option>
							<option value="HESSIAN">HESSIAN</option>
							<option value="SADPOINT">SADPOINT</option>
							<option value="IRC">IRC</option>
						</select>
					</div>
					<div class="config-group">
						<label>Theory</label>
						<select id="cfg-theory" onchange="updateGamessText()">
							<option value="RHF">RHF</option>
							<option value="UHF">UHF</option>
							<option value="DFT TYP=B3LYP">B3LYP (DFT)</option>
							<option value="MP2">MP2</option>
						</select>
					</div>
					<div class="config-group">
						<label>Basis Set</label>
						<select id="cfg-basis" onchange="updateGamessText()">
							<option value="STO">STO-3G</option>
							<option value="N21">3-21G</option>
							<option value="N31">6-31G</option>
							<option value="N31-D">6-31G(d)</option>
							<option value="N31-DP">6-31G(d,p)</option>
							<option value="N31-DP-DIFF">6-31+G(d,p)</option>
						</select>
					</div>
					<div class="config-group">
						<label>Charge</label>
						<select id="cfg-charge" onchange="updateGamessText()">
							<option value="-2">-2</option>
							<option value="-1">-1</option>
							<option value="0" selected>0 (Neutral)</option>
							<option value="1">+1</option>
							<option value="2">+2</option>
						</select>
					</div>
					<div class="config-group">
						<label>Multiplicity</label>
						<select id="cfg-mult" onchange="updateGamessText()">
							<option value="1">1 (Singlet)</option>
							<option value="2">2 (Doublet)</option>
							<option value="3">3 (Triplet)</option>
						</select>
					</div>
				</div>
			</div>
			<div class="resizer" id="resizer-gamess"></div>
			<div id="pane-editor" class="tool-pane col-right" style="display:flex; flex-direction:column;">
				<textarea id="gamess-editor" spellcheck="false"></textarea>
				<div class="editor-footer">
					<button id="ext-btn-download" onclick="downloadInp()">Download .inp File</button>
				</div>
			</div>
		</div>
	</div>

	<footer><div>Powered by Kekule.js</div></footer>

	<script>
	var composer, viewer, domBtnGen, domBtnTerminate, domBtnBabel, domBtnSwitch;
	var calculator, currentMode = 'modeling';

	function report(msg) { document.getElementById('state').innerHTML = msg; }

	function toggleMode() {
		const panelModeling = document.getElementById('panel-modeling');
		const panelGamess = document.getElementById('panel-gamess');
		domBtnSwitch = document.getElementById('ext-btn-switch');
		if (currentMode === 'modeling') {
			currentMode = 'gamess';
			panelModeling.classList.remove('active');
			panelGamess.classList.add('active');
			domBtnSwitch.innerHTML = 'Switch to Modeling Mode';
			report('Editor Mode');
			updateGamessText();
		} else {
			currentMode = 'modeling';
			panelGamess.classList.remove('active');
			panelModeling.classList.add('active');
			domBtnSwitch.innerHTML = 'Switch to Editor Mode';
			report('Modeling Mode');
			syncSizes();
		}
	}

	function updateGamessText() {
		var mol = viewer.getChemObj();
		var editor = document.getElementById('gamess-editor');
		if (!mol || mol.getNodeCount() === 0) {
			editor.value = "! No 3D coordinates available.\n! Please execute 'Generate 3D' in the Modeling pane.";
			return;
		}

		var theoryVal = document.getElementById('cfg-theory').value;
		var run = document.getElementById('cfg-run').value;
		var basisVal = document.getElementById('cfg-basis').value;
		var charge = document.getElementById('cfg-charge').value;
		var mult = document.getElementById('cfg-mult').value;

		var scftyp = (theoryVal.includes('B3LYP') || theoryVal === 'MP2') ? 'RHF' : theoryVal;
		if (mult > 1 && scftyp === 'RHF') scftyp = 'ROHF'; 

		var lines = [];
		var contrl = ` $CONTRL SCFTYP=${scftyp} RUNTYP=${run}`;
		if (charge !== "0") contrl += ` ICHARG=${charge}`;
		contrl += ` MULT=${mult}`;
		if (theoryVal.includes('B3LYP')) contrl += ` DFTTYP=B3LYP`;
		if (theoryVal === 'MP2') contrl += ` MPLEVL=2`;
		contrl += ` $END`;
		lines.push(contrl);

		var basisLine = "";
		switch(basisVal) {
			case 'STO': basisLine = " $BASIS GBASIS=STO NGAUSS=3 $END"; break;
			case 'N21': basisLine = " $BASIS GBASIS=N21 NGAUSS=3 $END"; break;
			case 'N31': basisLine = " $BASIS GBASIS=N31 NGAUSS=6 $END"; break;
			case 'N31-D': basisLine = " $BASIS GBASIS=N31 NGAUSS=6 NDFUNC=1 $END"; break;
			case 'N31-DP': basisLine = " $BASIS GBASIS=N31 NGAUSS=6 NDFUNC=1 NPFUNC=1 $END"; break;
			case 'N31-DP-DIFF': basisLine = " $BASIS GBASIS=N31 NGAUSS=6 NDFUNC=1 NPFUNC=1 DIFFSP=.TRUE. $END"; break;
		}
		lines.push(basisLine);

		if (run === 'HESSIAN' || run === 'SADPOINT') {
			lines.push(" $FORCE METHOD=ANALYTIC VIBANL=.TRUE. $END");
		}
		if (run === 'IRC') {
			lines.push(" $IRC SADDLE=.TRUE. FORWRD=.TRUE. NPOINT=100 STRIDE=0.1 $END");
		}
		if (run === 'OPTIMIZE') {
			lines.push(" $STATPT OPTTOL=0.0001 NSTEP=100 HSSEND=.TRUE. $END");
		}
		if (run === 'SADPOINT') {
			lines.push(" $STATPT OPTTOL=0.0001 NSTEP=100 HESS=CALC HSSEND=.TRUE. $END");
		}

		lines.push(' $DATA\nGAMESS Input generated by GfEditer (2026)\nC1');

		for (var i = 0; i < mol.getNodeCount(); ++i) {
			var node = mol.getNodeAt(i);
			if (node instanceof Kekule.Atom) {
				var coord = node.getAbsCoord3D() || node.getCoord3D();
				lines.push(` ${node.getSymbol().padEnd(5)} ${node.getAtomicNumber().toString().padStart(5)}.0 ${coord.x.toFixed(8).padStart(14)} ${coord.y.toFixed(8).padStart(14)} ${coord.z.toFixed(8).padStart(14)}`);
			}
		}
		lines.push(' $END');
		editor.value = lines.join('\n');
	}

	function generate3D() {
		var mol = Kekule.ChemStructureUtils.getTotalStructFragment(composer.getChemObj());
		if (!mol || mol.getNodeCount() === 0) return report('Canvas is empty');
		report('Calculating 3D...');
		domBtnGen.disabled = true;
		domBtnTerminate.disabled = false;
		calculator = Kekule.Calculator.generate3D(mol, {'forceField': 'MMFF94'},
			function(generatedMol){
				domBtnGen.disabled = false;
				domBtnTerminate.disabled = true;
				viewer.setChemObj(generatedMol);
				report('Modeling Mode (3D Ready)');
			},
			function() { domBtnGen.disabled = false; domBtnTerminate.disabled = true; report('Modeling Mode'); }
		);
	}

	function terminate() { if (calculator) calculator.halt(); domBtnGen.disabled = false; domBtnTerminate.disabled = true; report('Terminated'); }
	function downloadInp() {
		var blob = new Blob([document.getElementById('gamess-editor').value], { type: 'text/plain' });
		var a = document.createElement('a');
		a.href = URL.createObjectURL(blob);
		a.download = 'gamess_input.inp';
		a.click();
	}
	function enableOpenBabel() { Kekule.IO.enableOpenBabelFormats(); var btn = document.getElementById('ext-btn-babel'); btn.classList.add('active'); btn.innerHTML = '✓ OpenBabel Enabled'; report('OpenBabel Enabled'); }
	function syncSizes() { if (composer) composer.notifyObjectSizeChanged(); if (viewer) viewer.notifyObjectSizeChanged(); }

	function init() {
		viewer = Kekule.Widget.getWidgetById('chemViewer');
		composer = Kekule.Widget.getWidgetById('composer');
		domBtnGen = document.getElementById('ext-btn-gen');
		domBtnTerminate = document.getElementById('ext-btn-terminate');
		var editor = document.getElementById('gamess-editor');

		const setupResizer = (resizerId, panelId) => {
			const resizer = document.getElementById(resizerId);
			const leftCol = document.querySelector(`#${panelId} .col-left`);
			let isResizing = false;

			resizer.addEventListener('mousedown', (e) => { 
				isResizing = true; 
				document.body.style.cursor = 'col-resize';
			});

			window.addEventListener('mousemove', (e) => {
				if (!isResizing) return;
				const newWidth = (e.clientX / window.innerWidth) * 100;
				if (newWidth > 15 && newWidth < 85) { leftCol.style.flex = `0 0 ${newWidth}%`; syncSizes(); }
			});

			window.addEventListener('mouseup', () => { 
				isResizing = false; 
				document.body.style.cursor = 'default';
			});
		};

		setupResizer('resizer-modeling', 'panel-modeling');
		setupResizer('resizer-gamess', 'panel-gamess');

		// 重要：エディタ上でのクリックやキー操作がリサイズイベントに吸われないようにする
		editor.addEventListener('mousedown', function(e) { e.stopPropagation(); });
		editor.addEventListener('keydown', function(e) { e.stopPropagation(); });

		window.addEventListener('resize', syncSizes);
		setTimeout(syncSizes, 500);
	}
	Kekule.X.domReady(init);
	</script>
</body>
</html>
